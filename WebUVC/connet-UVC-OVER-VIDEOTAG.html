<h3>VideoTag - Example</h3>


<div id='results'>
  <div>
    <button id='getUserMediaButton'>Start Camera</button>
    <button id='releaseMediaButton'>Stop Camera</button>   
    <div>
      <video autoplay></video>
    </div>
    <input type="range">Adjust Zoom</input> 
    <div id="filter_section">
      <label for="filter">Filter: </label>
      <select id="filter">
          <option value="none">None</option>
          <option value="blur">Blur</option>
          <option value="grayscale">Grayscale</option>
          <option value="brightness">brightness</option>
          <option value="contrast">contrast</option>
          <option value="hue-rotate">hue-rotate</option>
          <option value="hue-rotate2">hue-rotate2</option>
          <option value="hue-rotate3">hue-rotate3</option>
          <option value="saturate">hue-rotate2</option>
          <option value="invert">Invert</option>
          <option value="sepia">Sepia</option>
      </select>
      <button id='applyFilterButton'>Apply Filter</button>
    </div>

    <div id="log"></div>
  </div>
  <!-- <div>
    <canvas id='grabFrameCanvas'></canvas>
    <button id='grabFrameButton'>Grab Frame</button>
  </div>
  <div>
    <canvas id='takePhotoCanvas'></canvas>
    <button id='takePhotoButton'>Take Photo</button>
  </div> -->
</div>

<style>
video, #cssfilters-video, #screenshot-img {
  width: 400px;
  height: 300px;
}
video, #cssfilters-stream {
  background: rgba(255,255,255,0.5);
  border: 1px solid #ccc;
}
.blur {
  -webkit-filter: blur(3px);
  -moz-filter: blur(3px);
  -o-filter: blur(3px);
  -ms-filter: blur(3px);
  filter: blur(3px);
}
.brightness {
  -webkit-filter: brightness(5);
  -moz-filter: brightness(5);
  -o-filter: brightness(5);
  -ms-filter: brightness(5);
  filter: brightness(5);
}
.contrast {
  -webkit-filter: contrast(8);
  -moz-filter: contrast(8);
  -o-filter: contrast(8);
  -ms-filter: contrast(8);
  filter: contrast(8);
}
.hue-rotate {
  -webkit-filter: hue-rotate(90deg);
  -moz-filter: hue-rotate(90deg);
  -o-filter: hue-rotate(90deg);
  -ms-filter: hue-rotate(90deg);
  filter: hue-rotate(90deg);
}
.hue-rotate2 {
  -webkit-filter: hue-rotate(180deg);
  -moz-filter: hue-rotate(180deg);
  -o-filter: hue-rotate(180deg);
  -ms-filter: hue-rotate(180deg);
  filter: hue-rotate(180deg);
}
.hue-rotate3 {
  -webkit-filter: hue-rotate(270deg);
  -moz-filter: hue-rotate(270deg);
  -o-filter: hue-rotate(270deg);
  -ms-filter: hue-rotate(270deg);
  filter: hue-rotate(270deg);
}
.saturate {
  -webkit-filter: saturate(10);
  -moz-filter: saturate(10);
  -o-filter: saturate(10);
  -ms-filter: saturate(10);
  filter: saturate(10);
}
.grayscale {
  -webkit-filter: grayscale(1);
  -moz-filter: grayscale(1);
  -o-filter: grayscale(1);
  -ms-filter: grayscale(1);
  filter: grayscale(1);
}
.sepia {
  -webkit-filter: sepia(1);
  -moz-filter: sepia(1);
  -o-filter: sepia(1);
  -ms-filter: sepia(1);
  filter: sepia(1);
}
.invert {
  -webkit-filter: invert(1);
  -moz-filter: invert(1);
  -o-filter: invert(1);
  -ms-filter: invert(1);
  filter: invert(1);
}
</style>


<script>
  
var imageCapture;
const videoElement = document.querySelector("video");
const filterSelect = document.querySelector('select#filter');
const logElement = document.querySelector("log");
const constraints = { audio: false, video: true };
//navigator.mediaDevices.getUserMedia(constraints).then((stream) => {video.srcObject = stream});

let filterIndex = 0;
const filters = [
  'grayscale',
  'sepia',
  'blur',
  'brightness',
  'contrast',
  'hue-rotate',
  'hue-rotate2',
  'hue-rotate3',
  'saturate',
  'invert',
  ''
];

// function onGetUserMediaButtonClick() {
//   navigator.mediaDevices.getUserMedia({video: true, audio: true})
//   .then(mediaStream => {
//     document.querySelector('video').srcObject = mediaStream;

//     const track = mediaStream.getVideoTracks()[0];
//     imageCapture = new ImageCapture(track);
//   })
//   .catch(error => ChromeSamples.log(error));
// }

function onGetUserMediaButtonClick() {

  navigator.mediaDevices.getUserMedia({
    video: true,
    audio: false
  }).then(function(stream) {
    let audioTracks = stream.getAudioTracks();
    let videoTracks = stream.getVideoTracks();
    
    videoElement.srcObject = stream;
    if (audioTracks.length) {
        audioTrack = audioTracks[0];
    }
    if (videoTracks.length) {
        videoTrack = videoTracks[0];
        imageCapture = new ImageCapture(videoTrack);
    }
  }).then(function() {
    new Promise(function(resolve) {
      videoElement.onloadedmetadata = resolve;
    });
  }).then(function() {

  }).catch(handleError);
}

function onReleaseMediaButtonClick(){

  document.getElementById("releaseMediaButton").addEventListener("click", function() {
  if (videoTrack) {
    videoTrack.stop();
  }
  if (audioTrack) {
    audioTrack.stop();
  }

  videoTrack = audioTrack = null;
  document.querySelector('video').srcObject = null;
  });
}

function onApplyFilterButtonClick(){
  console.log('onApplyFiterButtonClick: ',filters[filterIndex++ % filters.length]);
  //videoElement.className = filters[filterIndex++ % filters.length];
  videoElement.className = filterSelect.value;
}

function log(msg) {
  document.getElementById("log").innerHTML += (msg + "<br>");
  //logElement.innerHTML += (msg + "<br>");
}

function handleError(reason) {
  log("Error <code>" + reason.name +
      "</code> in constraint <code>" + reason.constraint +
      "</code>: " + reason.message);
}

function handleSuccess(stream) {
  window.stream = stream; // make stream available to browser console
  videoElement.srcObject = stream;
}

function handleError(error) {
  console.log('navigator.MediaDevices.getUserMedia error: ', error.message, error.name);
}

// function onGrabFrameButtonClick() {
//   imageCapture.grabFrame()
//   .then(imageBitmap => {
//     const canvas = document.querySelector('#grabFrameCanvas');
//     drawCanvas(canvas, imageBitmap);
//   })
//   .catch(error => ChromeSamples.log(error));
// }

function onTakePhotoButtonClick() {
  imageCapture.takePhoto()
  .then(blob => createImageBitmap(blob))
  .then(imageBitmap => {
    const canvas = document.querySelector('#takePhotoCanvas');
    drawCanvas(canvas, imageBitmap);
  })
  .catch(error => ChromeSamples.log(error));
}

/* Utils */

function drawCanvas(canvas, img) {
  canvas.width = getComputedStyle(canvas).width.split('px')[0];
  canvas.height = getComputedStyle(canvas).height.split('px')[0];
  let ratio  = Math.min(canvas.width / img.width, canvas.height / img.height);
  let x = (canvas.width - img.width * ratio) / 2;
  let y = (canvas.height - img.height * ratio) / 2;
  canvas.getContext('2d').clearRect(0, 0, canvas.width, canvas.height);
  canvas.getContext('2d').drawImage(img, 0, 0, img.width, img.height,
      x, y, img.width * ratio, img.height * ratio);
}

</script>

<script>
  document.querySelector('#getUserMediaButton').addEventListener('click', onGetUserMediaButtonClick);
  document.querySelector('#releaseMediaButton').addEventListener('click', onReleaseMediaButtonClick);
  document.querySelector('#applyFilterButton').addEventListener('click', onApplyFilterButtonClick);

  // document.querySelector('#grabFrameButton').addEventListener('click', onGrabFrameButtonClick);
  // document.querySelector('#takePhotoButton').addEventListener('click', onTakePhotoButtonClick);
</script>






