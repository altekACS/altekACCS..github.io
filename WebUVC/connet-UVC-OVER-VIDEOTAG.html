<h3>VideoTag - Example</h3>


<div id='results'>
  <div>
    <video autoplay></video>
    <div></div>
    <button id='getUserMediaButton'>Start Camera</button>
    <button id='releaseMediaButton'>Stop Camera</button>
    <input type="range">Adjust Zoom</input>

    <div id="filter_section">
      <label for="filter">Filter: </label>
      <select id="filter">
          <option value="none">None</option>
          <option value="blur">Blur</option>
          <option value="grayscale">Grayscale</option>
          <option value="invert">Invert</option>
          <option value="sepia">Sepia</option>
      </select>
    </div>

    <div id="log"></div>
  </div>
  <!-- <div>
    <canvas id='grabFrameCanvas'></canvas>
    <button id='grabFrameButton'>Grab Frame</button>
  </div>
  <div>
    <canvas id='takePhotoCanvas'></canvas>
    <button id='takePhotoButton'>Take Photo</button>
  </div> -->
</div>


<script>
  
var imageCapture;
let videoElement = document.querySelector("video");
let filterSelect = document.querySelector('select#filter');
let logElement = document.querySelector("log");
// function onGetUserMediaButtonClick() {
//   navigator.mediaDevices.getUserMedia({video: true, audio: true})
//   .then(mediaStream => {
//     document.querySelector('video').srcObject = mediaStream;

//     const track = mediaStream.getVideoTracks()[0];
//     imageCapture = new ImageCapture(track);
//   })
//   .catch(error => ChromeSamples.log(error));
// }

function onGetUserMediaButtonClick() {
  navigator.mediaDevices.getUserMedia({
    video: true,
    audio: true
  }).then(function(stream) {
    let audioTracks = stream.getAudioTracks();
    let videoTracks = stream.getVideoTracks();
    
    videoElement.srcObject = stream;
    if (audioTracks.length) {
        audioTrack = audioTracks[0];
    }
    if (videoTracks.length) {
        videoTrack = videoTracks[0];
        imageCapture = new ImageCapture(videoTrack);
    }
  }).then(function() {
    new Promise(function(resolve) {
      videoElement.onloadedmetadata = resolve;
    });
  }).then(function() {

  }).catch(handleError);
}

function onReleaseMediaButtonClick(){

  document.getElementById("releaseMediaButton").addEventListener("click", function() {
  if (videoTrack) {
    videoTrack.stop();
  }
  if (audioTrack) {
    audioTrack.stop();
  }

  videoTrack = audioTrack = null;
  document.querySelector('video').srcObject = null;
  });
}


filterSelect.onchange = function() {
  videoElement.className = filterSelect.value;
};

function log(msg) {
  logElement.innerHTML += (msg + "<br>");
}

function handleError(reason) {
  log("Error <code>" + reason.name +
      "</code> in constraint <code>" + reason.constraint +
      "</code>: " + reason.message);
}

// function onGrabFrameButtonClick() {
//   imageCapture.grabFrame()
//   .then(imageBitmap => {
//     const canvas = document.querySelector('#grabFrameCanvas');
//     drawCanvas(canvas, imageBitmap);
//   })
//   .catch(error => ChromeSamples.log(error));
// }

function onTakePhotoButtonClick() {
  imageCapture.takePhoto()
  .then(blob => createImageBitmap(blob))
  .then(imageBitmap => {
    const canvas = document.querySelector('#takePhotoCanvas');
    drawCanvas(canvas, imageBitmap);
  })
  .catch(error => ChromeSamples.log(error));
}

/* Utils */

function drawCanvas(canvas, img) {
  canvas.width = getComputedStyle(canvas).width.split('px')[0];
  canvas.height = getComputedStyle(canvas).height.split('px')[0];
  let ratio  = Math.min(canvas.width / img.width, canvas.height / img.height);
  let x = (canvas.width - img.width * ratio) / 2;
  let y = (canvas.height - img.height * ratio) / 2;
  canvas.getContext('2d').clearRect(0, 0, canvas.width, canvas.height);
  canvas.getContext('2d').drawImage(img, 0, 0, img.width, img.height,
      x, y, img.width * ratio, img.height * ratio);
}

// document.querySelector('video').addEventListener('play', function() {
//   document.querySelector('#grabFrameButton').disabled = false;
//   document.querySelector('#takePhotoButton').disabled = false;
// });


</script>

<script>
  document.querySelector('#getUserMediaButton').addEventListener('click', onGetUserMediaButtonClick);
  document.querySelector('#releaseMediaButton').addEventListener('click', onReleaseMediaButtonClick);
  // document.querySelector('#grabFrameButton').addEventListener('click', onGrabFrameButtonClick);
  // document.querySelector('#takePhotoButton').addEventListener('click', onTakePhotoButtonClick);
</script>


